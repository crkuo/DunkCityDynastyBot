name: PyInstaller Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest  # Windows 平台打包 .exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        if exist requirements.txt (pip install -r requirements.txt)

    - name: Build with PyInstaller using main.spec
      run: |
        pyinstaller main.spec
      shell: cmd

    - name: Prepare release package folder
      run: |
        mkdir packaged
        copy dist\main.exe packaged\main.exe
        xcopy assets packaged\assets /E /I
        copy config.json packaged\
        copy LICENSE packaged\
        powershell Compress-Archive -Path packaged\* -DestinationPath DunkCityDynastyBot_win.zip

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: DunkCityDynastyBot_win.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
